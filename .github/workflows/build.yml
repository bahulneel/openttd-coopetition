name: Build and Release

# Trigger workflow on push to main branch or manual trigger
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version number (leave empty to use version.nut)'
        required: false
        type: string

# Define permissions needed for GitHub releases
permissions:
  contents: write
  packages: read
  pull-requests: write

# Ensure only one workflow runs at a time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # First job: Get current version and increment it
  increment-version:
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      current_version: ${{ steps.get_current_version.outputs.version }}
      new_version: ${{ steps.increment_version.outputs.new_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          
      - name: Get current version
        id: get_current_version
        run: |
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            echo "version=${{ github.event.inputs.version_override }}" >> $GITHUB_OUTPUT
            echo "Using manually provided version: ${{ github.event.inputs.version_override }}"
          else
            VERSION=$(grep -o 'COOPETITION_VERSION = [0-9]\+' version.nut | grep -o '[0-9]\+')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Using version from version.nut: $VERSION"
          fi
      
      - name: Increment version
        id: increment_version
        run: |
          # Calculate new version
          NEW_VERSION=$((${{ steps.get_current_version.outputs.version }} + 1))
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Incrementing version from ${{ steps.get_current_version.outputs.version }} to $NEW_VERSION"
      
      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
      - name: Update version.nut
        run: |
          # Update version.nut with new version
          sed -i "s/COOPETITION_VERSION = ${{ steps.get_current_version.outputs.version }}/COOPETITION_VERSION = ${{ steps.increment_version.outputs.new_version }}/" version.nut
          cat version.nut
      
      - name: Create branch for version increment
        run: |
          # Create a new branch for the version increment
          BRANCH_NAME="release-v${{ steps.increment_version.outputs.new_version }}"
          git checkout -b $BRANCH_NAME
          git add version.nut
          git commit -m "Increment version to v${{ steps.increment_version.outputs.new_version }}"
          git push origin $BRANCH_NAME
      
      - name: Version Summary
        run: |
          echo "## Version Increment" >> $GITHUB_STEP_SUMMARY
          echo "✅ Incremented version from ${{ steps.get_current_version.outputs.version }} to ${{ steps.increment_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "🔀 Created branch release-v${{ steps.increment_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
  
  # Second job: Build and release with the new version
  build:
    needs: increment-version
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v5
        with:
          ref: release-v${{ needs.increment-version.outputs.new_version }}
      
      - name: Create dist directory
        run: mkdir -p dist
      
      - name: Package mod
        run: |
          zip -r "dist/coopetition-v${{ needs.increment-version.outputs.new_version }}.zip" \
            *.nut \
            LICENSE \
            README.md
          
      - name: Validate zip file
        run: |
          echo "Validating zip file integrity..."
          if unzip -t "dist/coopetition-v${{ needs.increment-version.outputs.new_version }}.zip"; then
            echo "✅ Zip file is valid"
          else
            echo "❌ Zip file validation failed"
            exit 1
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: coopetition-mod
          path: dist/*.zip
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip
          tag_name: v${{ needs.increment-version.outputs.new_version }}
          name: Coopetition v${{ needs.increment-version.outputs.new_version }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully built and released Coopetition v${{ needs.increment-version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "📦 Release URL: ${{ steps.create_release.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "📅 Released at: $(date)" >> $GITHUB_STEP_SUMMARY
  
  # Third job: Create PR back to develop
  create-pr:
    needs: [increment-version, build]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          base: develop
          branch: release-v${{ needs.increment-version.outputs.new_version }}
          title: "Release v${{ needs.increment-version.outputs.new_version }}"
          body: |
            This PR merges the release v${{ needs.increment-version.outputs.new_version }} back to the develop branch.
            
            ## Changes
            - Incremented version number from ${{ needs.increment-version.outputs.current_version }} to ${{ needs.increment-version.outputs.new_version }}
            - Created release v${{ needs.increment-version.outputs.new_version }}
          labels: version-bump, automated-pr
          
      - name: PR Summary
        run: |
          echo "## Pull Request" >> $GITHUB_STEP_SUMMARY
          echo "✅ Created PR to merge release-v${{ needs.increment-version.outputs.new_version }} to develop" >> $GITHUB_STEP_SUMMARY